<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test - Corporate Chat</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-top: 0;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.pending {
            background: #fff3cd;
            color: #856404;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
        }
        .log-entry.info {
            color: #0c5460;
        }
        .log-entry.success {
            color: #155724;
            font-weight: bold;
        }
        .log-entry.error {
            color: #721c24;
            font-weight: bold;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 300px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîå WebSocket Diagnostics</h1>

        <div class="test-section">
            <h2>1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket</h2>
            <div id="connectionStatus" class="status pending">‚è≥ –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</div>
            <div>
                <label>
                    Token (–∏–∑ localStorage):
                    <input type="text" id="tokenInput" placeholder="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è">
                </label>
            </div>
            <button id="connectBtn" onclick="connectWebSocket()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
            <button id="disconnectBtn" onclick="disconnectWebSocket()" disabled>–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
        </div>

        <div class="test-section">
            <h2>2. –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è</h2>
            <div id="sendStatus" class="status pending">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>
            <div>
                <label>
                    Chat ID:
                    <input type="number" id="chatIdInput" value="2" placeholder="2">
                </label>
            </div>
            <div>
                <label>
                    –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:
                    <input type="text" id="messageInput" value="üß™ –ê–≤—Ç–æ—Ç–µ—Å—Ç WebSocket" placeholder="–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
                </label>
            </div>
            <button id="sendBtn" onclick="sendTestMessage()" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
        </div>

        <div class="test-section">
            <h2>3. –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è WebSocket</h2>
            <div id="eventsCount" class="status pending">üìä –°–æ–±—ã—Ç–∏–π –ø–æ–ª—É—á–µ–Ω–æ: 0</div>
            <button onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
            <div id="eventsLog" class="log">
                <div class="log-entry info">–õ–æ–≥ —Å–æ–±—ã—Ç–∏–π –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...</div>
            </div>
        </div>

        <div class="test-section">
            <h2>4. –ê–≤—Ç–æ—Ç–µ—Å—Ç (–æ—Ç–ø—Ä–∞–≤–∫–∞ + –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è)</h2>
            <div id="autoTestStatus" class="status pending">‚è≥ –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –∑–∞–ø—É—Å–∫–∞</div>
            <button id="autoTestBtn" onclick="runAutoTest()" disabled>üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ—Ç–µ—Å—Ç</button>
            <div id="autoTestDetails" style="margin-top: 10px; font-size: 14px;"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket = null;
        let eventsReceived = 0;
        const API_URL = window.location.origin;

        // Get token from localStorage
        const token = localStorage.getItem('token');
        document.getElementById('tokenInput').value = token ? token.substring(0, 20) + '...' : '–ù–ï –ù–ê–ô–î–ï–ù';

        function log(message, type = 'info') {
            const logDiv = document.getElementById('eventsLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString('ru-RU');
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('eventsLog').innerHTML = '<div class="log-entry info">–õ–æ–≥ –æ—á–∏—â–µ–Ω...</div>';
            eventsReceived = 0;
            updateEventsCount();
        }

        function updateEventsCount() {
            document.getElementById('eventsCount').innerHTML = `üìä –°–æ–±—ã—Ç–∏–π –ø–æ–ª—É—á–µ–Ω–æ: ${eventsReceived}`;
        }

        function setStatus(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = `status ${type}`;
        }

        function connectWebSocket() {
            if (!token) {
                alert('Token –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage. –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É —Å–Ω–∞—á–∞–ª–∞.');
                return;
            }

            log('üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket...', 'info');
            setStatus('connectionStatus', '‚è≥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'pending');

            socket = io(API_URL, {
                auth: { token },
                transports: ['polling', 'websocket'],
                upgrade: true,
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionAttempts: 5
            });

            socket.on('connect', () => {
                log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω! Socket ID: ' + socket.id, 'success');
                setStatus('connectionStatus', '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ (ID: ' + socket.id + ')', 'success');
                setStatus('sendStatus', '‚úÖ –ì–æ—Ç–æ–≤ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ', 'success');
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('autoTestBtn').disabled = false;
            });

            socket.on('disconnect', (reason) => {
                log('‚ùå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω: ' + reason, 'error');
                setStatus('connectionStatus', '‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ: ' + reason, 'error');
                setStatus('sendStatus', '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'pending');
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                document.getElementById('sendBtn').disabled = true;
                document.getElementById('autoTestBtn').disabled = true;
            });

            socket.on('connect_error', (error) => {
                log('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message, 'error');
                setStatus('connectionStatus', '‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
            });

            // Listen for new_message events
            socket.on('new_message', (data) => {
                eventsReceived++;
                updateEventsCount();
                log(`üì® new_message: chatId=${data.chatId}, messageId=${data.message?.id}, sender=${data.message?.user_name}, content="${data.message?.content?.substring(0, 50)}"`, 'success');
            });

            // Listen for other events
            socket.on('user_typing', (data) => {
                eventsReceived++;
                updateEventsCount();
                log(`‚å®Ô∏è user_typing: chatId=${data.chatId}, user=${data.userName}`, 'info');
            });

            socket.on('message_deleted', (data) => {
                eventsReceived++;
                updateEventsCount();
                log(`üóëÔ∏è message_deleted: messageId=${data.messageId}`, 'info');
            });

            socket.on('message_read', (data) => {
                eventsReceived++;
                updateEventsCount();
                log(`üëÅÔ∏è message_read: chatId=${data.chatId}, userId=${data.userId}`, 'info');
            });
        }

        function disconnectWebSocket() {
            if (socket) {
                socket.disconnect();
                socket = null;
                log('üîå –û—Ç–∫–ª—é—á–µ–Ω–æ –≤—Ä—É—á–Ω—É—é', 'info');
            }
        }

        async function sendTestMessage() {
            const chatId = document.getElementById('chatIdInput').value;
            const content = document.getElementById('messageInput').value;

            if (!chatId || !content) {
                alert('–í–≤–µ–¥–∏—Ç–µ Chat ID –∏ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è');
                return;
            }

            log(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç ${chatId}: "${content}"`, 'info');
            setStatus('sendStatus', '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...', 'pending');

            try {
                const response = await fetch(`${API_URL}/api/chats/${chatId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content })
                });

                const data = await response.json();

                if (response.ok) {
                    log(`‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! ID: ${data.message?.id}`, 'success');
                    setStatus('sendStatus', '‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (ID: ' + data.message?.id + ')', 'success');
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${data.error || response.statusText}`, 'error');
                    setStatus('sendStatus', '‚ùå –û—à–∏–±–∫–∞: ' + (data.error || response.statusText), 'error');
                }
            } catch (err) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${err.message}`, 'error');
                setStatus('sendStatus', '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
            }
        }

        async function runAutoTest() {
            const detailsDiv = document.getElementById('autoTestDetails');
            detailsDiv.innerHTML = '';

            log('üöÄ ========== –ê–í–¢–û–¢–ï–°–¢ –ó–ê–ü–£–©–ï–ù ==========', 'success');
            setStatus('autoTestStatus', '‚è≥ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ—Ç–µ—Å—Ç...', 'pending');

            const chatId = document.getElementById('chatIdInput').value;
            const testMessage = `üß™ –ê–≤—Ç–æ—Ç–µ—Å—Ç ${new Date().toLocaleTimeString('ru-RU')}`;

            // Step 1: Count events before
            const eventsBefore = eventsReceived;
            log(`üìä –°–æ–±—ã—Ç–∏—è –î–û –æ—Ç–ø—Ä–∞–≤–∫–∏: ${eventsBefore}`, 'info');

            // Step 2: Send message
            log(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è...`, 'info');
            try {
                const response = await fetch(`${API_URL}/api/chats/${chatId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content: testMessage })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
                }

                log(`‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! ID: ${data.message?.id}`, 'success');

                // Step 3: Wait for WebSocket event
                log(`‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ WebSocket —Å–æ–±—ã—Ç–∏—è new_message (3 —Å–µ–∫—É–Ω–¥—ã)...`, 'info');

                await new Promise(resolve => setTimeout(resolve, 3000));

                const eventsAfter = eventsReceived;
                const newEvents = eventsAfter - eventsBefore;

                log(`üìä –°–æ–±—ã—Ç–∏—è –ü–û–°–õ–ï –æ—Ç–ø—Ä–∞–≤–∫–∏: ${eventsAfter} (–Ω–æ–≤—ã—Ö: ${newEvents})`, 'info');

                // Step 4: –†–µ–∑—É–ª—å—Ç–∞—Ç
                if (newEvents > 0) {
                    log(`‚úÖ –ê–í–¢–û–¢–ï–°–¢ –ü–†–û–ô–î–ï–ù! –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–π: ${newEvents}`, 'success');
                    setStatus('autoTestStatus', `‚úÖ –¢–ï–°–¢ –ü–†–û–ô–î–ï–ù! –ü–æ–ª—É—á–µ–Ω–æ ${newEvents} —Å–æ–±—ã—Ç–∏–π`, 'success');
                    detailsDiv.innerHTML = `
                        <div style="color: green;">
                            ‚úÖ WebSocket —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ!<br>
                            üì® –°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –ø–æ–ª—É—á–µ–Ω–æ —á–µ—Ä–µ–∑ WebSocket<br>
                            üéâ Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É—é—Ç
                        </div>
                    `;
                } else {
                    log(`‚ùå –ê–í–¢–û–¢–ï–°–¢ –ü–†–û–í–ê–õ–ï–ù! WebSocket —Å–æ–±—ã—Ç–∏—è –ù–ï –ü–û–õ–£–ß–ï–ù–´`, 'error');
                    setStatus('autoTestStatus', `‚ùå –¢–ï–°–¢ –ü–†–û–í–ê–õ–ï–ù! –°–æ–±—ã—Ç–∏—è –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã`, 'error');
                    detailsDiv.innerHTML = `
                        <div style="color: red;">
                            ‚ùå WebSocket –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç!<br>
                            üì§ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ HTTP API —É—Å–ø–µ—à–Ω–æ<br>
                            ‚ùå –ù–û —Å–æ–±—ã—Ç–∏–µ new_message –ù–ï –ø–æ–ª—É—á–µ–Ω–æ —á–µ—Ä–µ–∑ WebSocket<br>
                            <br>
                            <strong>–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:</strong><br>
                            ‚Ä¢ –°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏—è —á–µ—Ä–µ–∑ socket.io<br>
                            ‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ–º–Ω–∞—Ç—É —á–∞—Ç–∞ (socket.join)<br>
                            ‚Ä¢ –ü—Ä–æ–±–ª–µ–º–∞ —Å Nginx proxy –¥–ª—è /socket.io/<br>
                            ‚Ä¢ Socket.io –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –Ω–µ —ç–º–∏—Ç–∏—Ç —Å–æ–±—ã—Ç–∏—è<br>
                        </div>
                    `;
                }

            } catch (err) {
                log(`‚ùå –ê–í–¢–û–¢–ï–°–¢ –û–®–ò–ë–ö–ê: ${err.message}`, 'error');
                setStatus('autoTestStatus', `‚ùå –û—à–∏–±–∫–∞: ${err.message}`, 'error');
            }

            log('üöÄ ========== –ê–í–¢–û–¢–ï–°–¢ –ó–ê–í–ï–†–®–ï–ù ==========', 'success');
        }

        // Auto-connect on page load if token exists
        window.addEventListener('load', () => {
            if (token) {
                log('‚ÑπÔ∏è Token –Ω–∞–π–¥–µ–Ω, –∞–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'info');
                setTimeout(connectWebSocket, 500);
            } else {
                log('‚ùå Token –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage. –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.', 'error');
            }
        });
    </script>
</body>
</html>
