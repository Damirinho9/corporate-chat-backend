<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —á–∞—Ç</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        :root[data-theme="dark"] {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1e1e1e;
            --bg-tertiary: #2a2a2a;
            --bg-hover: #252525;
            --text-primary: #e4e4e4;
            --text-secondary: #b0b0b0;
            --text-tertiary: #888;
            --border: #2a2a2a;
            --accent: #4a9eff;
            --accent-hover: #3a8eef;
            --message-bubble: #1e1e1e;
            --message-own: #4a9eff;
            --danger: #ff4444;
            --success: #6eff6e;
            --warning: #ffaa00;
        }

        :root[data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e8e8e8;
            --bg-hover: #f0f0f0;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --border: #e0e0e0;
            --accent: #2196f3;
            --accent-hover: #1976d2;
            --message-bubble: #f0f0f0;
            --message-own: #2196f3;
            --danger: #f44336;
            --success: #4caf50;
            --warning: #ff9800;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background 0.3s, color 0.3s;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
        }

        .login-container {
            background: var(--bg-secondary);
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 450px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h2 {
            color: var(--accent);
            margin-bottom: 10px;
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border: none;
            padding: 12px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            transition: transform 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            background: var(--accent);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
        }

        .demo-users {
            margin-top: 25px;
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .demo-users h4 {
            color: var(--accent);
            margin-bottom: 15px;
            font-size: 14px;
        }

        .demo-user {
            padding: 10px 12px;
            margin: 5px 0;
            background: var(--bg-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }

        .demo-user:hover {
            background: var(--bg-hover);
        }

        .demo-user strong {
            color: var(--accent);
        }

        .error-message {
            padding: 12px;
            margin-bottom: 20px;
            background: rgba(244, 67, 54, 0.1);
            border-left: 4px solid var(--danger);
            border-radius: 4px;
            color: var(--danger);
            font-size: 14px;
        }

        /* Chat App */
        .chat-app {
            display: none;
            height: 100vh;
        }

        .chat-container {
            display: flex;
            height: 100%;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
        }

        .user-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .user-details h3 {
            font-size: 16px;
            margin-bottom: 4px;
        }

        .user-role {
            font-size: 12px;
            color: var(--accent);
        }

        .header-controls {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            position: relative;
            padding: 8px;
            background: var(--bg-secondary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            transition: background 0.2s;
        }

        .icon-btn:hover {
            background: var(--bg-hover);
        }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--danger);
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 5px;
            border-radius: 10px;
            min-width: 16px;
            text-align: center;
        }

        /* Admin panel */
        .admin-panel {
            padding: 15px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }

        .admin-btn {
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: opacity 0.2s;
        }

        .admin-btn:hover {
            opacity: 0.9;
        }

        /* Chats list */
        .chats-list {
            flex: 1;
            overflow-y: auto;
        }

        .chat-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        .chat-item:hover {
            background: var(--bg-hover);
        }

        .chat-item.active {
            background: var(--bg-tertiary);
        }

        .chat-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .chat-name {
            font-weight: 600;
            font-size: 14px;
        }

        .chat-time {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .chat-preview {
            font-size: 13px;
            color: var(--text-tertiary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .unread-badge {
            display: inline-block;
            padding: 2px 8px;
            background: var(--accent);
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            margin-left: 8px;
        }

        /* Chat area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
        }

        .chat-header {
            padding: 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header-info h3 {
            font-size: 18px;
            margin-bottom: 4px;
        }

        .chat-type {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .chat-header-actions {
            display: flex;
            gap: 10px;
        }

        /* Messages */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
        }

        .message.own {
            align-items: flex-end;
        }

        .message-header {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-bottom: 4px;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            background: var(--message-bubble);
            word-wrap: break-word;
        }

        .message.own .message-bubble {
            background: var(--message-own);
            color: white;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        /* Message input */
        .message-input-area {
            padding: 15px 20px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
        }

        .message-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 14px;
            resize: none;
            max-height: 150px;
            font-family: inherit;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .send-btn {
            padding: 12px 20px;
            background: var(--accent);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .send-btn:hover {
            background: var(--accent-hover);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-tertiary);
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }

        .toast {
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            margin-bottom: 10px;
            min-width: 300px;
            animation: slideIn 0.3s ease-out;
            border-left: 4px solid var(--accent);
        }

        .toast.success {
            border-left-color: var(--success);
        }

        .toast.error {
            border-left-color: var(--danger);
        }

        .toast.warning {
            border-left-color: var(--warning);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .toast-title {
            font-weight: 600;
            font-size: 14px;
        }

        .toast-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            color: var(--text-tertiary);
            padding: 0;
            margin-left: 10px;
        }

        .toast-message {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border);
        }
    </style>
</head>
<body>
    <!-- Theme toggle -->
    <button class="theme-toggle" onclick="toggleTheme()" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
        <span id="themeIcon">‚òÄÔ∏è</span>
    </button>

    <!-- Toast container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-header">
                <h2>üè¢ –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —á–∞—Ç</h2>
                <p style="color: var(--text-secondary);">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</p>
            </div>

            <div id="loginError" class="error-message" style="display: none;"></div>

            <form id="loginForm">
                <div class="form-group">
                    <label>–õ–æ–≥–∏–Ω</label>
                    <input type="text" id="username" placeholder="admin" required>
                </div>
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="password" placeholder="admin123" required>
                </div>
                <button type="submit" class="btn">–í–æ–π—Ç–∏</button>
            </form>

            <div class="demo-users">
                <h4>üìã –î–µ–º–æ-–∞–∫–∫–∞—É–Ω—Ç—ã (–∫–ª–∏–∫ –¥–ª—è –≤—Ö–æ–¥–∞):</h4>
                <div class="demo-user" onclick="quickLogin('admin', 'admin123')">
                    <strong>admin</strong> / admin123 - –ì–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
                </div>
                <div class="demo-user" onclick="quickLogin('assistant1', 'pass123')">
                    <strong>assistant1</strong> / pass123 - –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –ê–Ω–Ω–∞
                </div>
                <div class="demo-user" onclick="quickLogin('rop_sales', 'pass123')">
                    <strong>rop_sales</strong> / pass123 - –†–û–ü Sales
                </div>
                <div class="demo-user" onclick="quickLogin('operator1', 'pass123')">
                    <strong>operator1</strong> / pass123 - –û–ø–µ—Ä–∞—Ç–æ—Ä Sales
                </div>
            </div>
        </div>
    </div>

    <!-- Chat App -->
    <div class="chat-app" id="chatApp">
        <div class="chat-container">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="user-info-header">
                        <div class="user-details">
                            <h3 id="userName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h3>
                            <div class="user-role" id="userRole">–†–æ–ª—å</div>
                        </div>
                        <div class="header-controls">
                            <button class="icon-btn" onclick="toggleNotifications()" title="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">
                                üîî
                                <span class="notification-badge hidden" id="totalUnreadBadge">0</span>
                            </button>
                            <button class="icon-btn" onclick="logout()" title="–í—ã–π—Ç–∏">üö™</button>
                        </div>
                    </div>
                </div>

                <!-- Admin panel -->
                <div class="admin-panel hidden" id="adminPanel">
                    <button class="admin-btn" onclick="showToast('–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info')">‚ûï –°–æ–∑–¥–∞—Ç—å —á–∞—Ç</button>
                    <button class="admin-btn" onclick="showToast('–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info')">üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</button>
                </div>

                <!-- Chats list -->
                <div class="chats-list" id="chatsList">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</p>
                    </div>
                </div>
            </div>

            <!-- Chat area -->
            <div class="chat-area">
                <div class="chat-header">
                    <div class="chat-header-info">
                        <h3 id="currentChatName">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                        <div class="chat-type" id="currentChatType"></div>
                    </div>
                    <div class="chat-header-actions">
                        <button class="icon-btn" onclick="showToast('–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info')" title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è">‚ÑπÔ∏è</button>
                    </div>
                </div>

                <div class="messages-container" id="messagesContainer">
                    <div class="loading">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è</div>
                </div>

                <div class="message-input-area">
                    <div class="message-input-wrapper">
                        <textarea 
                            class="message-input" 
                            id="messageInput" 
                            placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                            rows="1"
                            onkeydown="handleInputKeydown(event)"
                        ></textarea>
                        <button class="send-btn" onclick="sendMessage()" id="sendBtn">‚û§</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        const API_URL = window.location.origin + '/api';
        let token = '';
        let currentUser = null;
        let socket = null;
        let currentChatId = null;
        let notificationsEnabled = false;
        let soundEnabled = true;

        // Notification sound
        const notificationSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBg==');

        // Theme
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            document.getElementById('themeIcon').textContent = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
            localStorage.setItem('theme', newTheme);
        }

        // Load theme
        window.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.getElementById('themeIcon').textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
            
            // Check for saved session
            const savedToken = localStorage.getItem('token');
            const savedUser = localStorage.getItem('user');
            
            if (savedToken && savedUser) {
                token = savedToken;
                currentUser = JSON.parse(savedUser);
                showChatApp();
            }
        });

        // Toast notifications
        function showToast(message, type = 'info', title = '') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const titles = {
                'success': '‚úÖ –£—Å–ø–µ—à–Ω–æ',
                'error': '‚ùå –û—à–∏–±–∫–∞',
                'warning': '‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ',
                'info': '‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è'
            };
            
            toast.innerHTML = `
                <div class="toast-header">
                    <span class="toast-title">${title || titles[type]}</span>
                    <button class="toast-close" onclick="this.parentElement.parentElement.remove()">‚úï</button>
                </div>
                <div class="toast-message">${message}</div>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            await login(username, password);
        });

        function quickLogin(username, password) {
            document.getElementById('username').value = username;
            document.getElementById('password').value = password;
            login(username, password);
        }

        async function login(username, password) {
            try {
                document.getElementById('loginError').style.display = 'none';
                
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await res.json();
                
                if (data.token) {
                    token = data.token;
                    currentUser = data.user;
                    
                    localStorage.setItem('token', token);
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    
                    showChatApp();
                    showToast('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                } else {
                    showError(data.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
                }
            } catch (err) {
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É: ' + err.message);
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function showChatApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('chatApp').style.display = 'block';
            
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = getRoleText(currentUser.role);
            
            if (canManageUsers()) {
                document.getElementById('adminPanel').classList.remove('hidden');
            }
            
            requestNotificationPermission();
            connectWebSocket();
            loadChats();
        }

        function getRoleText(role) {
            const roles = {
                'admin': 'üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
                'assistant': 'ü§ù –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç',
                'rop': 'üìä –†–û–ü',
                'operator': 'üíº –û–ø–µ—Ä–∞—Ç–æ—Ä',
                'employee': 'üë§ –°–æ—Ç—Ä—É–¥–Ω–∏–∫'
            };
            return roles[role] || role;
        }

        function logout() {
            if (confirm('–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã?')) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                if (socket) socket.disconnect();
                location.reload();
            }
        }

        function canManageUsers() {
            return currentUser.role === 'admin' || currentUser.role === 'rop';
        }

        // Notifications
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    notificationsEnabled = permission === 'granted';
                    if (notificationsEnabled) {
                        showToast('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã', 'success');
                    }
                });
            } else if (Notification.permission === 'granted') {
                notificationsEnabled = true;
            }
        }

        function toggleNotifications() {
            soundEnabled = !soundEnabled;
            showToast(
                soundEnabled ? '–ó–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤–∫–ª—é—á–µ–Ω' : '–ó–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤—ã–∫–ª—é—á–µ–Ω',
                'info'
            );
        }

        function showNotification(title, message) {
            if (notificationsEnabled && document.hidden) {
                new Notification(title, {
                    body: message,
                    icon: 'üè¢',
                    badge: 'üè¢'
                });
            }
            
            if (soundEnabled) {
                notificationSound.play().catch(() => {});
            }
        }

        // WebSocket
        function connectWebSocket() {
            socket = io(window.location.origin, {
                auth: { token }
            });

            socket.on('connect', () => {
                console.log('‚úÖ WebSocket connected');
                showToast('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É', 'success');
            });

            socket.on('disconnect', () => {
                console.log('‚ùå WebSocket disconnected');
                showToast('–û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞', 'warning');
            });

            socket.on('new_message', (data) => {
                if (data.chatId === currentChatId) {
                    addMessage(data.message);
                }
                
                updateChatPreview(data.chatId, data.message);
                
                if (data.message.user_id !== currentUser.id) {
                    updateUnreadCount(data.chatId, 1);
                    showNotification(
                        data.message.user_name,
                        data.message.content
                    );
                }
            });
        }

        // Load chats
        async function loadChats() {
            try {
                const res = await fetch(`${API_URL}/chats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }

                const data = await res.json();
                
                console.log('Chats loaded:', data);
                
                if (data.chats && data.chats.length > 0) {
                    renderChats(data.chats);
                } else {
                    document.getElementById('chatsList').innerHTML = `
                        <div class="loading">
                            <p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —á–∞—Ç–æ–≤</p>
                            <p style="font-size: 12px; color: var(--text-tertiary); margin-top: 10px;">
                                –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ —á–∞—Ç—ã
                            </p>
                        </div>
                    `;
                }
            } catch (err) {
                console.error('Error loading chats:', err);
                document.getElementById('chatsList').innerHTML = `
                    <div class="loading">
                        <p style="color: var(--danger);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤</p>
                        <p style="font-size: 12px; margin-top: 10px;">${err.message}</p>
                        <button class="btn" onclick="loadChats()" style="margin-top: 15px; padding: 8px 16px;">
                            –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                        </button>
                    </div>
                `;
                showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–∞—Ç—ã: ' + err.message, 'error');
            }
        }

        function renderChats(chats) {
            const container = document.getElementById('chatsList');
            container.innerHTML = '';

            let totalUnread = 0;

            chats.forEach(chat => {
                const chatDiv = document.createElement('div');
                chatDiv.className = 'chat-item';
                chatDiv.onclick = () => selectChat(chat);

                const chatName = getChatName(chat);
                const lastMsg = chat.last_message 
                    ? (chat.last_message.is_deleted ? 'üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ' : chat.last_message.content)
                    : '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
                const unreadCount = chat.unread_count || 0;
                
                totalUnread += unreadCount;

                chatDiv.innerHTML = `
                    <div class="chat-item-header">
                        <span class="chat-name">${chatName}</span>
                        <span class="chat-time">${chat.last_message ? formatTime(chat.last_message.created_at) : ''}</span>
                    </div>
                    <div class="chat-preview">
                        ${escapeHtml(lastMsg).substring(0, 40)}${lastMsg.length > 40 ? '...' : ''}
                        ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
                    </div>
                `;

                container.appendChild(chatDiv);
            });

            updateTotalUnreadBadge(totalUnread);
        }

        function getChatName(chat) {
            if (chat.name) return chat.name;
            
            if (chat.type === 'direct' && chat.participants) {
                const other = chat.participants.find(p => p.id !== currentUser.id);
                return other ? `${other.name}` : '–õ–∏—á–Ω—ã–π —á–∞—Ç';
            }
            
            return chat.type === 'group' ? 'üë• –ì—Ä—É–ø–ø–∞' : 'üè¢ ' + (chat.department || '–û—Ç–¥–µ–ª');
        }

        function updateTotalUnreadBadge(count) {
            const badge = document.getElementById('totalUnreadBadge');
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.classList.remove('hidden');
                document.title = `(${count}) –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —á–∞—Ç`;
            } else {
                badge.classList.add('hidden');
                document.title = '–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —á–∞—Ç';
            }
        }

        function updateUnreadCount(chatId, increment) {
            const chatItems = document.querySelectorAll('.chat-item');
            // TODO: Update specific chat unread count
            loadChats(); // Reload for now
        }

        function updateChatPreview(chatId, message) {
            // TODO: Update chat preview without full reload
        }

        async function selectChat(chat) {
            currentChatId = chat.id;
            document.getElementById('currentChatName').textContent = getChatName(chat);
            document.getElementById('currentChatType').textContent = getTypeText(chat.type);
            
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.chat-item').classList.add('active');

            await loadMessages(chat.id);
        }

        function getTypeText(type) {
            const types = {
                'direct': 'üí¨ –õ–∏—á–Ω–∞—è –ø–µ—Ä–µ–ø–∏—Å–∫–∞',
                'group': 'üë• –ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç',
                'department': 'üè¢ –ß–∞—Ç –æ—Ç–¥–µ–ª–∞'
            };
            return types[type] || type;
        }

        async function loadMessages(chatId) {
            try {
                const res = await fetch(`${API_URL}/chats/${chatId}/messages`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await res.json();
                
                const container = document.getElementById('messagesContainer');
                container.innerHTML = '';

                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(msg => addMessage(msg));
                } else {
                    container.innerHTML = '<div class="loading">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ!</div>';
                }
            } catch (err) {
                console.error('Error loading messages:', err);
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π', 'error');
            }
        }

        function addMessage(msg) {
            const container = document.getElementById('messagesContainer');
            const isOwn = msg.user_id === currentUser.id;

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isOwn ? 'own' : ''}`;

            messageDiv.innerHTML = `
                ${!isOwn ? `<div class="message-header">${msg.user_name}</div>` : ''}
                <div class="message-bubble">
                    ${escapeHtml(msg.content)}
                </div>
                <div class="message-time">${formatTime(msg.created_at)}</div>
            `;

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content || !currentChatId) return;

            try {
                await fetch(`${API_URL}/chats/${currentChatId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content })
                });

                input.value = '';
                input.style.height = 'auto';
            } catch (err) {
                console.error('Error sending message:', err);
                showToast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
            }
        }

        function handleInputKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        // Utilities
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 86400000) {
                return date.toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            } else {
                return date.toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit'
                });
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>