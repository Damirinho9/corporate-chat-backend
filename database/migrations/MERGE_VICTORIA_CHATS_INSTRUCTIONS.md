# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—é —á–∞—Ç–æ–≤ —Å –í–∏–∫—Ç–æ—Ä–∏–µ–π

## üìã –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏—è

- ‚úÖ –ü–µ—Ä–µ–Ω–æ—Å–∏—Ç –≤—Å–µ 18 —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤ —á–∞—Ç 58
- ‚úÖ –£–¥–∞–ª—è–µ—Ç –°–µ—Ä–≥–µ—è –∏–∑ direct —á–∞—Ç–æ–≤ —Å –í–∏–∫—Ç–æ—Ä–∏–µ–π
- ‚úÖ –£–¥–∞–ª—è–µ—Ç –ø—É—Å—Ç—ã–µ —á–∞—Ç—ã-–¥—É–±–ª–∏–∫–∞—Ç—ã (46, 51, 43, 41, 38, 35)
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (timestamps, —Ñ–∞–π–ª—ã, —Ä–µ–∞–∫—Ü–∏–∏)

## üöÄ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞ production

### –®–∞–≥ 1: –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ production —Å–µ—Ä–≤–µ—Ä—É

```bash
ssh damir@your-server.com
cd ~/corporate-chat-backend
```

### –®–∞–≥ 2: –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

```bash
git fetch origin
git checkout claude/fix-message-counter-sync-01J9feAopDMd2g9mRtZq6AFn
git pull origin claude/fix-message-counter-sync-01J9feAopDMd2g9mRtZq6AFn
```

### –®–∞–≥ 3: (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø –ë–î

```bash
# –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π
pg_dump -U postgres -d chat_db > backup_before_merge_$(date +%Y%m%d_%H%M%S).sql
```

### –®–∞–≥ 4: –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

```bash
# Dry run - –ø–æ–∫–∞–∂–µ—Ç —á—Ç–æ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞–Ω–æ –ë–ï–ó –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
node database/migrations/run_merge_victoria_chats.js

# –†–µ–∞–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (—Ç—Ä–µ–±—É–µ—Ç —Ñ–ª–∞–≥ --confirm)
node database/migrations/run_merge_victoria_chats.js --confirm
```

### –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç –ø–æ–∫–∞–∂–µ—Ç:
- ‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ 58
- ‚úÖ –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞ 58 (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å: –î–∞–º–∏—Ä, –ú–∞–∫–∞—Ä–æ–≤–∞ –í–∏–∫—Ç–æ—Ä–∏—è –ì–µ–Ω–Ω–∞–¥–∏–µ–≤–Ω–∞)
- ‚úÖ –ß—Ç–æ –¥—É–±–ª–∏–∫–∞—Ç—ã —É–¥–∞–ª–µ–Ω—ã

### –®–∞–≥ 6: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä

```bash
pm2 restart corporate-chat
```

### –®–∞–≥ 7: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ

1. –û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç —Å –í–∏–∫—Ç–æ—Ä–∏–µ–π
2. –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤–∏–¥–Ω–æ –≤—Å–µ 18 —Å–æ–æ–±—â–µ–Ω–∏–π
3. –¢–æ–ª—å–∫–æ 2 —É—á–∞—Å—Ç–Ω–∏–∫–∞: –≤—ã –∏ –í–∏–∫—Ç–æ—Ä–∏—è

## üîÑ –û—Ç–∫–∞—Ç (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫)

–ï—Å–ª–∏ –≤—ã —Å–æ–∑–¥–∞–ª–∏ –±—ç–∫–∞–ø –Ω–∞ —à–∞–≥–µ 3:

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
pm2 stop corporate-chat

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±—ç–∫–∞–ø–∞
psql -U postgres -d chat_db < backup_before_merge_YYYYMMDD_HHMMSS.sql

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
pm2 start corporate-chat
```

## üìä –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ç–∞–±–ª–∏—Ü—ã:
- `messages` - –∏–∑–º–µ–Ω–µ–Ω chat_id –¥–ª—è 18 —Å–æ–æ–±—â–µ–Ω–∏–π
- `chats` - —É–¥–∞–ª–µ–Ω–æ 6 –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (46, 51, 43, 41, 38, 35)
- `chat_participants` - —É–¥–∞–ª–µ–Ω –°–µ—Ä–≥–µ–π –∏–∑ direct —á–∞—Ç–æ–≤

### SQL –æ–ø–µ—Ä–∞—Ü–∏–∏:
- UPDATE messages SET chat_id = 58 WHERE chat_id IN (46, 51, 43, 41, 38, 35)
- DELETE FROM chat_participants WHERE user_id = 13 AND ...
- DELETE FROM chats WHERE id IN (46, 51, 43, 41, 38, 35)

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- ‚úÖ –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π ROLLBACK –ø—Ä–∏ –æ—à–∏–±–∫–µ
- ‚úÖ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–æ –∏ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

## ‚ùì –í–æ–ø—Ä–æ—Å—ã?

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –∏–¥—ë—Ç –Ω–µ —Ç–∞–∫, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. –õ–æ–≥–∏: `pm2 logs corporate-chat`
2. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î: –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è DB_*
3. –ë—ç–∫–∞–ø –ë–î —Å–æ–∑–¥–∞–Ω –¥–æ –º–∏–≥—Ä–∞—Ü–∏–∏
