# üß™ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã

## –û–ø–∏—Å–∞–Ω–∏–µ

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏—Å—Ç–µ–º—ã –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.

## –ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è

### –°–∏—Å—Ç–µ–º–∞ –ø—Ä–∞–≤:
1. ‚úÖ **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã** - –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å –≤—Å–µ–º
2. ‚úÖ **–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç—ã** - –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å –≤—Å–µ–º
3. ‚úÖ **–†–û–ü—ã** - –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å –≤—Å–µ–º
4. ‚úÖ **–û–ø–µ—Ä–∞—Ç–æ—Ä—ã** - –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å:
   - ‚úÖ –í—Å–µ–º –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞–º
   - ‚úÖ –°–≤–æ–µ–º—É –†–û–ü—É (—Ç–æ–ª—å–∫–æ —Å–≤–æ–µ–≥–æ –æ—Ç–¥–µ–ª–∞)
   - ‚ùå –ù–ï –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å —á—É–∂–∏–º –†–û–ü–∞–º
   - ‚ùå –ù–ï –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å –¥—Ä—É–≥–∏–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –õ–°:
5. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —á–∞—Ç–æ–≤
6. ‚úÖ –û—Ç–∫—Ä—ã—Ç–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —á–∞—Ç–æ–≤
7. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–æ–æ–±—â–µ–Ω–∏—è–º
8. ‚úÖ –ò–∑–æ–ª—è—Ü–∏—è —á–∞—Ç–æ–≤ (–ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ –Ω–µ –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø–∞)

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. Node.js —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
2. –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ `http://localhost:3000`
3. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

–ï—Å–ª–∏ —É –≤–∞—Å –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω `node-fetch`:

```bash
npm install --save-dev node-fetch@2
```

## –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ë–î

–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏:

```bash
npm run seed
```

–î–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:

| –õ–æ–≥–∏–Ω | –ü–∞—Ä–æ–ª—å | –†–æ–ª—å | –û—Ç–¥–µ–ª |
|-------|--------|------|-------|
| admin | admin123 | admin | - |
| assist1 | pass123 | assistant | - |
| assist2 | pass123 | assistant | - |
| rop1 | pass123 | rop | 4 –æ—Ç–¥–µ–ª |
| rop2 | pass123 | rop | 2 –æ—Ç–¥–µ–ª |
| rop3 | pass123 | rop | –û—Ç–¥–µ–ª 3 |
| op1a | pass123 | operator | 4 –æ—Ç–¥–µ–ª |
| op1b | pass123 | operator | 4 –æ—Ç–¥–µ–ª |
| op2a | pass123 | operator | 2 –æ—Ç–¥–µ–ª |
| op3a | pass123 | operator | –û—Ç–¥–µ–ª 3 |

## –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

### 1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä

```bash
npm start
```

–ò–ª–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞:

```bash
node server.js
```

### 2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã

–í –Ω–æ–≤–æ–º –æ–∫–Ω–µ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞:

```bash
node tests/permissions.test.js
```

## –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

```
============================================================
üß™ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã —Å–∏—Å—Ç–µ–º—ã –ø—Ä–∞–≤ –∏ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
============================================================

1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  ‚úì –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è admin (admin)
  ‚úì –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è assist1 (assistant)
  ‚úì –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è assist2 (assistant)
  ‚úì –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è rop1 (rop)
  ‚úì –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è rop2 (rop)
  ‚úì –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è rop3 (rop)
  ‚úì –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è op1a (operator)
  ‚úì –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è op1b (operator)
  ‚úì –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è op2a (operator)
  ‚úì –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è op3a (operator)

2. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —á–∞—Ç—ã —Å–æ –≤—Å–µ–º–∏
  ‚úì –ê–¥–º–∏–Ω ‚Üí rop1: OK
  ‚úì –ê–¥–º–∏–Ω ‚Üí op1a: OK
  ‚úì –ê–¥–º–∏–Ω ‚Üí assist1: OK

3. –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —á–∞—Ç—ã —Å–æ –≤—Å–µ–º–∏
  ‚úì –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç ‚Üí admin: OK
  ‚úì –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç ‚Üí rop1: OK
  ‚úì –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç ‚Üí op1a: OK

4. –†–û–ü –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —á–∞—Ç—ã —Å–æ –≤—Å–µ–º–∏
  ‚úì –†–û–ü ‚Üí admin: OK
  ‚úì –†–û–ü ‚Üí assist1: OK
  ‚úì –†–û–ü ‚Üí op1a: OK
  ‚úì –†–û–ü ‚Üí rop2: OK

5. –û–ø–µ—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —á–∞—Ç—ã —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞–º–∏
  ‚úì –û–ø–µ—Ä–∞—Ç–æ—Ä ‚Üí assist1: OK
  ‚úì –û–ø–µ—Ä–∞—Ç–æ—Ä ‚Üí assist2: OK

6. –û–ø–µ—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —á–∞—Ç—ã —Å–æ —Å–≤–æ–∏–º –†–û–ü–æ–º
  ‚úì –û–ø–µ—Ä–∞—Ç–æ—Ä 1–ê ‚Üí –†–û–ü 1 (—Å–≤–æ–π –æ—Ç–¥–µ–ª): OK

7. –û–ø–µ—Ä–∞—Ç–æ—Ä—ã –ù–ï –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —á–∞—Ç—ã —Å —á—É–∂–∏–º –†–û–ü–æ–º
  ‚úì –û–ø–µ—Ä–∞—Ç–æ—Ä 1–ê ‚úó –†–û–ü 2 (—á—É–∂–æ–π –æ—Ç–¥–µ–ª): –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω

8. –û–ø–µ—Ä–∞—Ç–æ—Ä—ã –ù–ï –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —á–∞—Ç—ã –º–µ–∂–¥—É —Å–æ–±–æ–π
  ‚úì –û–ø–µ—Ä–∞—Ç–æ—Ä 1–ê ‚úó –û–ø–µ—Ä–∞—Ç–æ—Ä 1–ë (—Ç–æ—Ç –∂–µ –æ—Ç–¥–µ–ª): –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω
  ‚úì –û–ø–µ—Ä–∞—Ç–æ—Ä 1–ê ‚úó –û–ø–µ—Ä–∞—Ç–æ—Ä 2–ê (–¥—Ä—É–≥–æ–π –æ—Ç–¥–µ–ª): –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω

9. –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
  ‚úì –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å –≤–µ—Ä–Ω—É–ª —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —á–∞—Ç (ID: 15)

10. –î–æ—Å—Ç—É–ø –∫ —Å–æ–æ–±—â–µ–Ω–∏—è–º —á–∞—Ç–∞
  ‚úì –ê–¥–º–∏–Ω –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —á–∞—Ç—É 15
  ‚úì –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —á–∞—Ç—É 15
  ‚úì –ü–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π –ù–ï –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —á–∞—Ç—É 15

============================================================
üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
============================================================

–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤: 30
–ü—Ä–æ–π–¥–µ–Ω–æ: 30
–ü—Ä–æ–≤–∞–ª–µ–Ω–æ: 0
–£—Å–ø–µ—à–Ω–æ—Å—Ç—å: 100.0%
```

## –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

```
‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: fetch failed
```

**–†–µ—à–µ–Ω–∏–µ**: –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ `http://localhost:3000`

### –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

```
‚úó –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è admin (admin)
```

**–†–µ—à–µ–Ω–∏–µ**:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –ë–î –∑–∞–ø–æ–ª–Ω–µ–Ω–∞: `npm run seed`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä–æ–ª–∏ –≤ seed.js
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `bcryptjs` –≤–æ –≤—Å–µ—Ö –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö

### –ü—Ä–æ–≤–∞–ª–µ–Ω—ã —Ç–µ—Å—Ç—ã –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

```
‚úó –û–ø–µ—Ä–∞—Ç–æ—Ä 1–ê ‚úó –†–û–ü 2 (—á—É–∂–æ–π –æ—Ç–¥–µ–ª): –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω
```

**–†–µ—à–µ–Ω–∏–µ**:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é `can_send_direct_message` –≤ –ë–î
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ middleware –≤ `middleware/permissions.js`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∞–≤–∏–ª—å–Ω–æ —É–∫–∞–∑–∞–Ω—ã –æ—Ç–¥–µ–ª—ã

## –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–≤–æ–∏—Ö —Ç–µ—Å—Ç–æ–≤

–í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–∏ —Ç–µ—Å—Ç—ã –≤ —Ñ–∞–π–ª `tests/permissions.test.js`:

```javascript
await test('11. –ú–æ–π –Ω–æ–≤—ã–π —Ç–µ—Å—Ç', async () => {
    // –í–∞—à –∫–æ–¥ —Ç–µ—Å—Ç–∞
    const res = await request('POST', '/chats/direct', tokens.admin, {
        receiverId: someUserId
    });

    assert(
        res.ok,
        `–û–ø–∏—Å–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞`
    );
});
```

## CI/CD Integration

–¢–µ—Å—Ç—ã –º–æ–∂–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ CI/CD pipeline:

```yaml
# .github/workflows/test.yml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
      - run: npm install
      - run: npm run seed
      - run: npm start &
      - run: sleep 5
      - run: node tests/permissions.test.js
```

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞.
