# Инструкция по миграции для синхронизации отделов и чатов

## Проблема

В текущей БД:
- `users.department` = "Sales", "Marketing", "IT"
- `chats.name` = "Отдел продаж", "Отдел маркетинга", "Отдел IT"
- `chats.department` = "Sales", "Marketing", "IT"

Названия чатов и отделов **не совпадают**, поэтому синхронизация не работает.

## Решение

### Вариант 1: Быстрый фикс (без миграции)

Выполните SQL запрос напрямую в вашей БД:

```sql
-- Синхронизируем названия чатов с названиями отделов
UPDATE chats c
SET name = department
WHERE type = 'department'
  AND department IS NOT NULL;
```

После этого:
- "Отдел продаж" → "Sales"
- "Отдел маркетинга" → "Marketing"
- "Отдел IT" → "IT"

### Вариант 2: Полная миграция с триггерами (рекомендуется)

1. **Установите переменные окружения:**

   Создайте файл `.env` с переменной `DATABASE_URL`:
   ```bash
   DATABASE_URL=postgresql://user:password@localhost:5432/dbname
   ```

2. **Запустите миграцию:**

   ```bash
   node database/migrate.js 004_create_departments_table.sql
   ```

   Или все миграции сразу:
   ```bash
   node database/migrate.js
   ```

3. **Что делает миграция:**
   - ✅ Создаёт таблицу `departments`
   - ✅ Создаёт таблицу `department_chats` (связь 1:1 между отделом и чатом)
   - ✅ Заполняет таблицы из существующих данных
   - ✅ Создаёт **триггеры** для автоматической синхронизации:
     - При переименовании отдела → обновляется чат и пользователи
     - При переименовании чата отдела → обновляется отдел и пользователи
   - ✅ Синхронизирует текущие данные

4. **После миграции:**
   - Переименование будет работать автоматически через триггеры БД
   - Не нужно менять код контроллеров
   - Данные всегда будут синхронизированы

## Проверка

После любого варианта, проверьте:

```sql
-- Должны совпадать name и department для чатов отделов
SELECT id, name, type, department
FROM chats
WHERE type = 'department';

-- Должны совпадать с отделами пользователей
SELECT DISTINCT department
FROM users
WHERE department IS NOT NULL;
```

## Тестирование синхронизации

После миграции попробуйте:

1. Переименовать отдел через админ-панель:
   - Зайдите в "Отделы"
   - Нажмите "✏️ Переименовать"
   - Измените название, например, "Sales" → "Продажи"

2. Проверьте что изменилось:
   - Название отдела в списке
   - Название чата в левой панели
   - `users.department` для всех пользователей отдела

3. Переименуйте чат отдела:
   - Откройте чат отдела
   - Перейдите в настройки чата
   - Измените название
   - Проверьте что отдел тоже переименовался

Всё должно синхронизироваться автоматически!
